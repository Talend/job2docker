### Description

Repackage a standard Talend job zip file as a Layer and publish to AWS Lambda using the [aws lambda publish-layer-version](https://docs.aws.amazon.com/cli/latest/reference/lambda/publish-layer-version.html) command.

* If you run this script multiple times for the same job, each run will have a different local working directory as well as S3 files created.
So nothing will be overwritten or have collisions.
* Each run of this script will result in the creation of a new Layer that will be referenced by the Lambda Function.
So it will update the existing Lambda rather than create a new Lambda, but the old Layers will still be retained.
* The historic linkage between a Layer and the zip file in the s3 bucket is captured in the consolidated configuration log <job_root>_config.log.
The sam_project_id property has the locally generated uuid.
* The talend_job_layer_version_arn property has the specific Layer ARN.


### Usage

    ./job2lambda <s3_bucket> <job_zip_path> [ <job_zip_target_dir> [ <working_dir> [ <description> [ <license> ] [ <stack_name> [ <template_file_path> [ <lambda_config_path> [ <job_config_path> ] ] ] ] ] ] ] ]

        s3_bucket:          s3 bucket where lambda layer will be stored 
        job_zip_path:       the path to the talend job zip file
        job_zip_target_dir: defaults to the current working directory
        working_dir:        defaults to the environment variable TALEND_JOB2LAMBDA_WORKING_DIR
                            if TALEND_JOB2LAMBDA_WORKING_DIR is not set defaults to HOME/tmp/job2lambda
        stack_name:         defaults to the derived job_root variable
        template_file_path: the AWS SAM cloud formation template file
                            defaults to job_lambda_template.yaml in the current working directory.
                            if no job_lambda_template.yaml file is found, then look in the job2lambda/config directory.
                            if neither of those files is found, then the default here document in this bash script is used.
        lambda_config_path  property settings used to configure aws lambda (e.g. aws roles, timeout, etc)
        job_config_path     property settings used to configure an individual lambda job (e.g. memory)

Global Environment Variables

    TALEND_JOB2LAMBDA_WORKING_DIR


### Configuration Files

Configurations are loaded from multiple locations.  First, common configurations are loaded from the job2lambda/config directory.
Then any configurations in the current directory are loaded, potentially overriding some or all of the common configurations.
Finally, files passed as the lambda_config_path or job_config_path parameters take precedence and are loaded, overriding the others.

For lambda_config the default file names are always lambda.cfg.

For job_config the default file names are config/job.cfg, PWD/job.cfg, and PWD/<job_root>.cfg.  So there is an additional layer of
configuration for jobs versus lambda environment.

Files passed via parameter of course can be naming anything.

All configurations are consolidated and logged to <job_root>_config.log.


### Details

The Talend job zip file located at job_zip_path is unzipped and modified in the working_dir.
The packaged job layer file is stored in the job_zip_target_dir before being copied to the s3_bucket.
The description and license parameters are passed along with the s3 zip file location to the Lambda Layer service.

Talend Job naming conventions result in the job_zip_path file name being something like

    <job_root>_<job_version>.zip

Note that the Talend job version does not necessarily match the git version.
The Talend version may be set in the Job properties.

* The job will be published to the s3_bucket in a folder named <job_root>/<sam_project_id>
where <sam_project_id> is derived from the uuid used to generate the local directory.
AWS Lambda automatically versions all Layers.
* The name of the layer will be just the job root name.
* Once the job zip file is published as a Layer, the Lambda itself will be created.
* The Talend Job version number is not used in the Lambda naming convention.

For example, the local job zip file

    mypath/Spring_Resources_RDS_0.1.zip 

would be published to 

    s3://eost-lambda/Spring_Resources_RDS/XXXXXX/Spring_Resources_RDS_0.1.zip

and the resulting Layer would be

    Spring_Resources_RDS

The Layer would be used by a Function with name

    Spring-Resources-RDS-SpringResourcesRDS-E0BRXFU0H0BD

The "Spring-Resources-RDS" portion of the Function name is the Stack Name.

The "SpringResourcesRDS" is the logical resource id derived from the job name and rendered as alphanumeric (no underscores or hyphens) as required by AWS resource ids.

The E0BRXFU0H0BD is generated by AWS when creating the Lambda resource and it can captured via the aws cloudformation describe command if needed.

So the business key of this entity is the Stack Name and logical resource id.  The surrogate key is the E0BRXFU0H0BD generated by AWS.

The Function would be part of a Cloud Formation Stack named

    Spring-Resources-RDS

Note that the Cloud Formation id uses hyphens rather than underscores.
Within the Cloud Formation stack there is a Lambda resource with logical id Spring-Resources-RDS-SpringResourcesRDS-E0BRXFU0H0BD mentioned previously.
Note that the logical resource id uses neither hyphens nor underscores.
